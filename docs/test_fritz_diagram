@startuml
title Home Lab Infra Monitor â€“ FritzBox monitoring tests (pytest + FastAPI)

' Swimlanes: three parallel columns

|Unit test:\nget_fritz_status uses settings|
start
:Pytest starts\n`test_get_fritz_status_uses_hosts_from_settings()`;
:Monkeypatch `fritz_monitor.get_settings`\n-> DummySettings with\n`fritzbox_hosts = ["192.168.178.1", "fritz.box"]`;
:Monkeypatch `_ping_host`\n-> `fake_ping_host(host)` returning\nFritzHostStatus objects;
:Call `get_fritz_status()`;\nloop over hosts and call `_ping_host(host)`;
:Collect FritzHostStatus\nobjects into list `statuses`;
:Return `statuses` to the test;
:Assertions:\n- len(statuses) == 2\n- items are FritzHostStatus\n- field values match expectations;
stop

|Integration test:\n/fritz/status endpoint|
start
:Pytest starts\n`test_fritz_status_endpoint_structure()`;
:Monkeypatch `get_fritz_status`\n-> `fake_get_fritz_status()`\n(list[FritzHostStatus]);
:TestClient sends\n`GET /fritz/status`;
:FastAPI routes request\nto `/fritz/status` endpoint;
:Endpoint calls\n`get_fritz_status()`;
:Service returns fake\nlist[FritzHostStatus];
:FastAPI serializes models\nto JSON response;
:Test receives response;
:Assertions:\n- status_code == 200\n- list length == 2\n- keys: host, is_up,\n  latency_ms, error\n- values & types are correct;
stop

|Error handling test:\nping binary missing|
start
:Pytest starts\n`test_ping_binary_missing_sets_error_flag()`;
:Monkeypatch `subprocess.run`\ninside fritz_monitor\n-> raise FileNotFoundError("ping not found");
:Call `_ping_host("fritz.box")`;
:Catch FileNotFoundError\ninside `_ping_host`;
:Create FritzHostStatus with\nhost="fritz.box",\nis_up=False,\nlatency_ms=None,\nerror="ping binary not found ...";
:Return status object;
:Assertions:\n- host == "fritz.box"\n- is_up is False\n- latency_ms is None\n- error contains\n  "ping binary not found";
stop

@enduml

